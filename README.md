# Управление окружениями Rubackup в OpenNebula

Этот репозиторий содержит два основных плейбука Ansible:

* `create_vm.yml` — создаёт или удаляет набор виртуальных машин в выбранном окружении OpenNebula и генерирует инвентарь для последующей конфигурации.
* `configure_vm.yml` — настраивает созданные виртуальные машины (ключи SSH, сеть, NAT, hostname и проброс RDP).

## Предварительные требования

* Ansible 2.11+ с коллекциями `community.general` и `ansible.utils`.
* Доступ к API OpenNebula и корректные учётные данные в `vars.yml`.
* Закрытый ключ SSH (`id_rsa` по умолчанию) рядом с плейбуками для подключения к виртуальным машинам.

## Создание окружения

```bash
ansible-playbook create_vm.yml -e env=st-11
```

Плейбук:

1. Загружает параметры окружения из `inventories/<имя>.yml`.
2. Создаёт пять виртуальных машин с префиксом имени окружения (`st-11-rubackup_bastion` и т.д.).
3. Присваивает метку окружения всем ВМ для удобного поиска.
4. После развёртывания запрашивает информацию о ВМ, формирует файл инвентаря `generated_inventories/<имя>.yml` с готовыми SSH-настройками и прокси через бастион.

> При необходимости путь к ключу SSH можно переопределить: `-e ssh_key_path=/path/to/key`.

## Удаление окружения

```bash
ansible-playbook create_vm.yml -e env=st-11 -e state=absent
```

Плейбук удалит все виртуальные машины с префиксом окружения и удалит соответствующий сгенерированный инвентарь.

## Конфигурация виртуальных машин

После успешного развёртывания выполните настройку:

```bash
ansible-playbook -i generated_inventories/st-11.yml configure_vm.yml
```

Плейбук выполнит следующие действия:

* создаст каталог `.ssh` и добавит ваш публичный ключ пользователю `astra`;
* поднимет второй интерфейс на бастионе, включит форвардинг и настроит NAT;
* пропишет шлюз по умолчанию и hostname на внутренних узлах;
* установит необходимые пакеты на сервере и клиенте;
* настроит проброс RDP-портов через бастион.

## Добавление нового окружения

1. Скопируйте один из файлов `inventories/st-XX.yml` и обновите `env_name`, `intnet_network_id`, `extnet_network_id`, `network_prefix` и `labels`.
2. Запустите плейбук `create_vm.yml` с новым значением `env`.

## Использование с Jenkins

* Создание: `ansible-playbook create_vm.yml -e env=<имя>`
* Удаление: `ansible-playbook create_vm.yml -e env=<имя> -e state=absent`
* Конфигурация: `ansible-playbook -i generated_inventories/<имя>.yml configure_vm.yml`

Эти команды удобно обернуть в джобы Jenkins, передавая параметр окружения.
